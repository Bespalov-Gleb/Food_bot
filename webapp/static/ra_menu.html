<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é</title>
  <link rel="stylesheet" href="/static/styles.v23.css?v=29" />
  <style>
    .admin-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 20px;
    }
    
    .admin-btn {
      padding: 10px 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    
    .admin-btn:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .menu-item {
      background: #f8fafc;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .menu-title {
      font-weight: 600;
      color: #1e293b;
    }
    
    .menu-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    
    .menu-actions button {
      padding: 6px 12px;
      background: white;
      color: #374151;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 32px;
    }
    
    .menu-actions button:hover {
      background: #f9fafb;
    }
    
    .menu-actions button.edit {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .menu-actions button.delete {
      background: #dc2626;
      color: white;
      border-color: #dc2626;
    }
    
    .menu-actions button.edit:hover {
      background: #2563eb;
    }
    
    .menu-actions button.delete:hover {
      background: #b91c1c;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #374151;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .form-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .form-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    
    .form-buttons button.save {
      background: #10b981;
      color: white;
    }
    
    .form-buttons button.cancel {
      background: #6b7280;
      color: white;
    }
    
    .form-buttons button.save:hover {
      background: #059669;
    }
    
    .form-buttons button.cancel:hover {
      background: #4b5563;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 16px;
    }
    
    .menu-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .modal-close:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .modal-actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .modal-actions .btn-cancel {
      background: #6b7280;
      color: white;
    }
    
    .modal-actions .btn-save {
      background: #10b981;
      color: white;
    }
    
    .modal-actions .btn-save:hover {
      background: #059669;
    }

    .file-upload {
      position: relative;
      display: inline-block;
      cursor: pointer;
      width: 100%;
    }
    
    .file-upload input[type=file] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-upload-label {
      display: block;
      padding: 12px;
      border: 2px dashed #d1d5db;
      border-radius: 6px;
      text-align: center;
      color: #6b7280;
      transition: all 0.2s ease;
    }
    
    .file-upload:hover .file-upload-label {
      border-color: #3b82f6;
      color: #3b82f6;
    }
    
    .image-preview {
      max-width: 200px;
      max-height: 150px;
      margin-top: 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      object-fit: cover;
      object-position: center;
      width: 100%;
      height: 150px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    
    .checkbox-group label {
      margin: 0;
      font-weight: normal;
    }

    .icon-btn {
      padding: 6px 12px;
      background: white;
      color: #374151;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 32px;
    }
    
    .icon-btn:hover {
      background: #f9fafb;
    }
    
    .icon-btn.edit {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .icon-btn.delete {
      background: #dc2626;
      color: white;
      border-color: #dc2626;
    }
    
    .icon-btn.add {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    
    .icon-btn.save {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    
    .icon-btn.edit:hover {
      background: #2563eb;
    }
    
    .icon-btn.delete:hover {
      background: #b91c1c;
    }
    
    .icon-btn.add:hover {
      background: #059669;
    }
    
    .icon-btn.save:hover {
      background: #059669;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é</h2>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="meta" style="margin-bottom:16px">
      <a id="navRestaurants" href="#">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</a>
      <span style="opacity:.4;margin:0 8px">|</span>
      <a id="navOrders" href="#">–ó–∞–∫–∞–∑—ã</a>
      <span style="opacity:.4;margin:0 8px">|</span>
      <span id="navMenu" style="font-weight:600">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é</span>
      <span style="opacity:.4;margin:0 8px">|</span>
      <a id="navProfile" href="#">–ü—Ä–æ—Ñ–∏–ª—å –∞–¥–º–∏–Ω–∞</a>
    </div>

    <!-- –°–µ–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω—é -->
    <div class="menu-section">
      <div class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é</div>
      <button id="loadMenu" class="admin-btn" style="width: auto;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é</button>
      <div id="menu"></div>
    </div>
  </div>

  <script>
const api = location.origin + '/api';
    const q = new URLSearchParams(location.search);
    const uid = Number(q.get('uid')) || (window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 0);
    const headers = uid ? { 'X-Telegram-User-Id': String(uid) } : {};

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    document.getElementById('navRestaurants').onclick = (e) => {
      e.preventDefault();
      const p = new URLSearchParams(location.search);
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
      location.href = '/static/index.html?' + p.toString();
    };

    document.getElementById('navOrders').onclick = (e) => {
      e.preventDefault();
      const p = new URLSearchParams(location.search);
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
      location.href = '/static/ra.html?' + p.toString();
    };

    document.getElementById('navProfile').onclick = (e) => {
      e.preventDefault();
      const p = new URLSearchParams(location.search);
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
      location.href = '/static/ra_profile.html?' + p.toString();
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é
    async function loadMenu() {
      try {
        const res = await fetch(api + '/ra/menu', { headers });
        
        if (!res.ok) {
          document.getElementById('menu').innerHTML = '<div class="meta">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–Ω—é</div>';
          return;
        }
        
        const data = await res.json();
        renderMenu(data);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:', error);
        document.getElementById('menu').innerHTML = '<div class="meta">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é</div>';
      }
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–µ–Ω—é
    function renderMenu(data) {
      const root = document.getElementById('menu');
      root.innerHTML = '';
      
      // –ü–∞–Ω–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      const addCat = document.createElement('div');
      addCat.className = 'menu-item';
      addCat.innerHTML = `
        <div class="section-title">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
        </div>
        <div class="form-group">
          <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <input id="newCatSort" placeholder="0" class="small" type="number"/>
        </div>
        <div class="form-buttons">
          <button class="icon-btn add" title="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é" id="newCatBtn">‚ûï</button>
        </div>`;
      root.appendChild(addCat);
      
      document.getElementById('newCatBtn').onclick = async () => {
        const name = document.getElementById('newCatName').value.trim();
        const sort = parseInt(document.getElementById('newCatSort').value||'0',10);
        if (!name) return;
        await fetch(api + '/ra/categories', { method:'POST', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify({ name, sort: Number.isNaN(sort)?0:sort }) });
        loadMenu();
      };

      data.categories.forEach(c => {
        const box = document.createElement('div');
        box.className = 'menu-item';
        box.innerHTML = `<div class="section-title">${c.name}</div>`;
        
        const catRow = document.createElement('div');
        catRow.className = 'form-group';
        catRow.innerHTML = `
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input value="${c.name}" data-cname/>
          <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <input value="${c.sort}" data-csort class="small" type="number"/>
          <div class="form-buttons">
            <button class="icon-btn save" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" data-csave>üíæ</button>
            <button class="icon-btn delete" title="–£–¥–∞–ª–∏—Ç—å" data-cdel>üóëÔ∏è</button>
          </div>`;
        
        catRow.querySelector('[data-csave]').onclick = async () => {
          const name = catRow.querySelector('[data-cname]').value.trim();
          const sort = parseInt(catRow.querySelector('[data-csort]').value||'0',10);
          await fetch(api + '/ra/categories/' + c.id, { method:'PATCH', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify({ name, sort }) });
          loadMenu();
        };
        
        catRow.querySelector('[data-cdel]').onclick = async () => {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –≤—Å–µ –µ—ë –±–ª—é–¥–∞?')) return;
          await fetch(api + '/ra/categories/' + c.id, { method:'DELETE', headers });
          loadMenu();
        };
        box.appendChild(catRow);
        
        const ds = data.dishes.filter(d => d.category_id === c.id);
        ds.forEach(d => {
          const row = document.createElement('div');
          row.className = 'menu-item';
          row.style.marginLeft = '20px';
          row.innerHTML = `
            <div class="menu-header">
              <span class="menu-title">${d.name} ‚Äî ${d.price} ‚ÇΩ</span>
            </div>
            <div class="menu-actions">
              <button class="icon-btn edit" title="–ò–∑–º–µ–Ω–∏—Ç—å" data-edit="${d.id}">‚úèÔ∏è</button>
              <button class="icon-btn options" title="–û–ø—Ü–∏–∏" data-opts="${d.id}">‚öôÔ∏è</button>
              <button class="icon-btn delete" title="–£–¥–∞–ª–∏—Ç—å" data-id="${d.id}">üóëÔ∏è</button>
            </div>`;
          
          row.querySelector('[data-id]').onclick = async () => {
            await fetch(api + '/ra/dishes/' + d.id, { method:'DELETE', headers });
            loadMenu();
          };
          
          row.querySelector('[data-edit]').onclick = () => {
            showDishEditModal(d);
          };
          
          // –ö–Ω–æ–ø–∫–∞ –æ–ø—Ü–∏–π
          const optsBtn = row.querySelector('[data-opts]');
          const optsContainer = document.createElement('div');
          optsContainer.className = 'menu-item';
          optsContainer.style.marginLeft = '20px';
          optsBtn.onclick = async () => {
            if (optsContainer.dataset.loaded === '1') { 
              optsContainer.innerHTML = ''; 
              optsContainer.dataset.loaded='0'; 
              return; 
            }
            const resp = await fetch(api + '/dishes/' + d.id + '/options');
            const dataO = await resp.json();
            renderOptionsEditor(d, dataO, optsContainer);
            optsContainer.dataset.loaded='1';
          };
          box.appendChild(row);
          box.appendChild(optsContainer);
        });
        
        // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞
        const form = document.createElement('div');
        form.className = 'menu-item';
        form.style.marginLeft = '20px';
        form.innerHTML = `
          <div class="section-title">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</div>
          <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input data-f="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
          </div>
          <div class="form-group">
            <label>–¶–µ–Ω–∞</label>
            <input data-f="price" placeholder="0" class="small" type="number"/>
          </div>
          <div class="form-buttons">
            <button class="icon-btn add" title="–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ" data-f="add">‚ûï</button>
          </div>`;
        
        form.querySelector('[data-f="add"]').onclick = async () => {
          const name = form.querySelector('[data-f="name"]').value.trim();
          const price = parseInt(form.querySelector('[data-f="price"]').value||'0',10);
          if (!name || !price) return;
          await fetch(api + '/ra/dishes', { method:'POST', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify({ category_id: c.id, name, price }) });
          loadMenu();
        };
        box.appendChild(form);
        root.appendChild(box);
      });
    }

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª—é–¥–∞
    function showDishEditModal(dish) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ</div>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>
          <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" id="dish-name" value="${dish.name}" />
          </div>
          <div class="form-group">
            <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
            <input type="number" id="dish-price" value="${dish.price}" />
          </div>
          <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="dish-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥–∞">${dish.description || ''}</textarea>
          </div>
          <div class="form-group">
            <label>–§–æ—Ç–æ</label>
            <div class="file-upload">
              <input type="file" id="dish-image-file" accept="image/*" />
              <div class="file-upload-label">
                ${dish.image ? '–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ'}
              </div>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 4px;">
              –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ª—é–±–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –≤–µ—Ä—Å–∏–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ (200x200), –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (400x400) –∏ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
            </div>
            ${dish.image ? `<img src="${dish.image}" class="image-preview" id="current-image" />` : ''}
            <img id="new-image-preview" class="image-preview" style="display: none;" />
          </div>
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="dish-available" ${dish.is_available ? 'checked' : ''}/>
              <label for="dish-available">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∑–∞–∫–∞–∑–∞</label>
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn-cancel" onclick="this.closest('.modal-overlay').remove()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-save" onclick="saveDishEdit(${dish.id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
      const fileInput = modal.querySelector('#dish-image-file');
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = modal.querySelector('#new-image-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
            modal.querySelector('#current-image').style.display = 'none';
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–ª—é–¥–∞
    async function saveDishEdit(dishId) {
      const modal = document.querySelector('.modal-overlay');
      const name = modal.querySelector('#dish-name').value.trim();
      const price = parseInt(modal.querySelector('#dish-price').value || '0', 10);
      const description = modal.querySelector('#dish-description').value.trim();
      const isAvailable = modal.querySelector('#dish-available').checked;
      const fileInput = modal.querySelector('#dish-image-file');
      
      if (!name || !price) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É');
        return;
      }
      
      const body = { name, price, description, is_available: isAvailable };
      
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
      if (fileInput.files[0]) {
        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        
        try {
          const uploadResponse = await fetch(api + '/ra/upload-image', {
            method: 'POST',
            headers: { 'X-Telegram-User-Id': uid },
            body: formData
          });
          
          if (uploadResponse.ok) {
            const uploadResult = await uploadResponse.json();
            body.image = uploadResult.image_url;
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
          alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
          return;
        }
      }
      
      try {
        await fetch(api + '/ra/dishes/' + dishId, {
          method: 'PATCH',
          headers: { ...headers, 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        modal.remove();
        loadMenu();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –æ–ø—Ü–∏–π
    function renderOptionsEditor(dish, dataO, container) {
      container.innerHTML = `<div class="section-title">–û–ø—Ü–∏–∏ –¥–ª—è –±–ª—é–¥–∞: ${dish.name}</div>`;
      const groups = dataO.groups || [];
      const options = dataO.options || [];
      
      // –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É
      const addG = document.createElement('div');
      addG.className='menu-item';
      addG.innerHTML = `
        <div class="section-title">–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</div>
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input data-n placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
        </div>
        <div class="form-group">
          <label>–ú–∏–Ω–∏–º—É–º</label>
          <input data-min value="0" class="small" type="number"/>
        </div>
        <div class="form-group">
          <label>–ú–∞–∫—Å–∏–º—É–º</label>
          <input data-max value="1" class="small" type="number"/>
        </div>
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" data-req/>
            <label>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</label>
          </div>
        </div>
        <div class="form-buttons">
          <button class="icon-btn add" title="–î–æ–±–∞–≤–∏—Ç—å" data-add>‚ûï</button>
        </div>`;
      
      addG.querySelector('[data-add]').onclick = async () => {
        const name = addG.querySelector('[data-n]').value.trim();
        const minv = parseInt(addG.querySelector('[data-min]').value||'0',10);
        const maxv = parseInt(addG.querySelector('[data-max]').value||'1',10);
        const req = !!addG.querySelector('[data-req]').checked;
        if (!name) return;
        await fetch(api + '/ra/option-groups', { method:'POST', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify({ dish_id: dish.id, name, min_select: minv, max_select: maxv, required: req }) });
        optsRefresh();
      };
      container.appendChild(addG);

      groups.forEach(g => {
        const gWrap = document.createElement('div'); 
        gWrap.className='menu-item';
        gWrap.innerHTML = `<div class="section-title">–ì—Ä—É–ø–ø–∞: ${g.name}</div>`;
        
        const row = document.createElement('div'); 
        row.className='form-group';
        row.innerHTML = `
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input value="${g.name}" data-gn/>
          <label>–ú–∏–Ω–∏–º—É–º</label>
          <input value="${g.min_select}" data-min class="small" type="number"/>
          <label>–ú–∞–∫—Å–∏–º—É–º</label>
          <input value="${g.max_select}" data-max class="small" type="number"/>
          <div class="checkbox-group">
            <input type="checkbox" data-req ${g.required?'checked':''}/>
            <label>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</label>
          </div>
          <div class="form-buttons">
            <button class="icon-btn save" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" data-save>üíæ</button>
            <button class="icon-btn delete" title="–£–¥–∞–ª–∏—Ç—å" data-del>üóëÔ∏è</button>
          </div>`;
        
        row.querySelector('[data-save]').onclick = async () => {
          const body = {
            name: row.querySelector('[data-gn]').value.trim(),
            min_select: parseInt(row.querySelector('[data-min]').value||'0',10),
            max_select: parseInt(row.querySelector('[data-max]').value||'1',10),
            required: !!row.querySelector('[data-req]').checked,
          };
          await fetch(api + '/ra/option-groups/' + g.id, { method:'PATCH', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
          optsRefresh();
        };
        
        row.querySelector('[data-del]').onclick = async () => {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É —Å–æ –≤—Å–µ–º–∏ –æ–ø—Ü–∏—è–º–∏?')) return;
          await fetch(api + '/ra/option-groups/' + g.id, { method:'DELETE', headers });
          optsRefresh();
        };
        gWrap.appendChild(row);

        // –°–ø–∏—Å–æ–∫ –æ–ø—Ü–∏–π –≤ –≥—Ä—É–ø–ø–µ
        const list = document.createElement('div');
        options.filter(o => o.group_id === g.id).forEach(o => {
          const line = document.createElement('div'); 
          line.className='menu-item';
          line.style.marginLeft = '20px';
          line.innerHTML = `
            <div class="form-group">
              <label>–û–ø—Ü–∏—è</label>
              <input value="${o.name}" data-on/>
            </div>
            <div class="form-group">
              <label>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã</label>
              <input value="${o.price_delta}" data-d class="small" type="number"/>
            </div>
            <div class="form-buttons">
              <button class="icon-btn save" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" data-osave>üíæ</button>
              <button class="icon-btn delete" title="–£–¥–∞–ª–∏—Ç—å" data-odel>üóëÔ∏è</button>
            </div>`;
          
          line.querySelector('[data-osave]').onclick = async () => {
            const body = { name: line.querySelector('[data-on]').value.trim(), price_delta: parseInt(line.querySelector('[data-d]').value||'0',10) };
            await fetch(api + '/ra/options/' + o.id, { method:'PATCH', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
            optsRefresh();
          };
          
          line.querySelector('[data-odel]').onclick = async () => {
            await fetch(api + '/ra/options/' + o.id, { method:'DELETE', headers });
            optsRefresh();
          };
          list.appendChild(line);
        });
        gWrap.appendChild(list);

        // –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏—é
        const addOpt = document.createElement('div'); 
        addOpt.className='menu-item';
        addOpt.style.marginLeft = '20px';
        addOpt.innerHTML = `
          <div class="section-title">–ù–æ–≤–∞—è –æ–ø—Ü–∏—è</div>
          <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input data-nm placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
          </div>
          <div class="form-group">
            <label>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã</label>
            <input data-delta value="0" class="small" type="number"/>
          </div>
          <div class="form-buttons">
            <button class="icon-btn add" title="–î–æ–±–∞–≤–∏—Ç—å" data-add>‚ûï</button>
          </div>`;
        
        addOpt.querySelector('[data-add]').onclick = async () => {
          const nm = addOpt.querySelector('[data-nm]').value.trim();
          const dlt = parseInt(addOpt.querySelector('[data-delta]').value||'0',10);
          if (!nm) return;
          await fetch(api + '/ra/options', { method:'POST', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify({ group_id: g.id, name: nm, price_delta: dlt }) });
          optsRefresh();
        };
        gWrap.appendChild(addOpt);
        container.appendChild(gWrap);
      });

      async function optsRefresh(){
        const resp = await fetch(api + '/dishes/' + dish.id + '/options');
        const dataO2 = await resp.json();
        renderOptionsEditor(dish, dataO2, container);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.getElementById('loadMenu').onclick = loadMenu;
    loadMenu();
  </script>
</body>
</html> 