<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–¥–º–∏–Ω–∫–∞</title>
  <link rel="stylesheet" href="/static/admin.css?v=7" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <h2>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
    
    <!-- Quick Actions Grid -->
    <div class="admin-grid">
      <div class="admin-section">
        <h3 id="quickActionsToggle" style="cursor: pointer; user-select: none;">
          <span id="quickActionsIcon">‚ñº</span> –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        </h3>
        <div id="quickActionsContent">
          <div class="form-group">
            <label>–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω</label>
            <input id="rname" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞"/>
            <button id="addR">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          
          <div class="form-group">
            <label>–°–æ–∑–¥–∞—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å –∞–¥–º–∏–Ω–æ–º</label>
            <input id="newRestName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞"/>
            <input id="newRestUsername" placeholder="@username –∏–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"/>
            <button id="createRestWithAdmin">üë• –°–æ–∑–¥–∞—Ç—å —Å –∞–¥–º–∏–Ω–æ–º</button>
            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
              üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ï—Å–ª–∏ username –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 
              ID –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å, –ø–æ–ø—Ä–æ—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É /start
            </div>
          </div>
          
          <div class="form-group">
            <label>–†–∞—Å—Å—ã–ª–∫–∞</label>
            <input id="btext" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"/>
            <button id="sendB">üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>
      
      <div class="admin-section">
        <h3 id="usersToggle" style="cursor: pointer; user-select: none;">
          <span id="usersIcon">‚ñ∂</span> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        </h3>
        <div id="usersContent" style="display: none;">
          <div class="form-group">
            <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ @username</label>
            <input id="uidInput" placeholder="123456 –∏–ª–∏ @username"/>
          </div>
          <div class="form-row">
            <button id="blk">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="unblk">‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div class="form-group">
            <label>–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</label>
            <div class="form-row">
              <input id="bindRestId" placeholder="ID —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞"/>
              <button id="bindRA">üëë –ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
            </div>
          </div>
          <button id="uload">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
          <div id="ulist"></div>
        </div>
      </div>
       
       <div class="admin-section">
         <h3 id="systemToggle" style="cursor: pointer; user-select: none;">
          <span id="systemIcon">‚ñ∂</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã
        </h3>
        <div id="systemContent" style="display: none;">
          <div class="form-group">
            <label>–ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫—É</label>
            <div class="form-row">
              <input id="adminCodeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ"/>
              <button id="updateAdminCode">üîê –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
              üí° –¢–µ–∫—É—â–µ–µ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ: <span id="currentAdminCode">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
          </div>
        </div>
      </div>
       
       <div class="admin-section">
         <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h3>
         <div class="form-group">
           <label>–ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫—É</label>
           <div class="form-row">
             <input id="adminCodeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ"/>
             <button id="updateAdminCode">üîê –û–±–Ω–æ–≤–∏—Ç—å</button>
           </div>
           <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
             üí° –¢–µ–∫—É—â–µ–µ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ: <span id="currentAdminCode">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
           </div>
         </div>
       </div>
       
      <div class="admin-section">
        <h3 id="collectionsToggle" style="cursor: pointer; user-select: none;">
          <span id="collectionsIcon">‚ñ∂</span> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∞–º–∏
        </h3>
        <div id="collectionsContent" style="display: none;">
          <div class="form-group">
            <label>–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É</label>
            <input id="collectionName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏"/>
            <input id="collectionDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏"/>
            <input id="collectionImage" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"/>
            <div class="form-row">
              <button id="createCollection">üìö –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É</button>
              <button id="loadCollections">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
          </div>
          <div id="collectionsList"></div>
        </div>
      </div>
    </div>

    <!-- Restaurants Section -->
    <div class="admin-section">
      <h3 id="restaurantsToggle" style="cursor: pointer; user-select: none;">
        <span id="restaurantsIcon">‚ñ∂</span> –†–µ—Å—Ç–æ—Ä–∞–Ω—ã
      </h3>
      <div id="restaurantsContent" style="display: none;">
        <div id="list"></div>
      </div>
    </div>

    <!-- Statistics Section -->
    <div class="admin-section">
      <h3 id="statsToggle" style="cursor: pointer; user-select: none;">
        <span id="statsIcon">‚ñ∂</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      </h3>
      <div id="statsContent" style="display: none;">
        <div class="form-row">
          <button id="statsRefresh">üìä –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        </div>
        <div id="statsGlobal"></div>
        
        <div class="form-group">
          <label>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É</label>
          <div class="form-row">
            <select id="statsRest"></select>
            <button id="statsLoad">üìà –ü–æ–∫–∞–∑–∞—Ç—å</button>
          </div>
        </div>
        <div id="statsByRest"></div>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="admin-section">
      <h3 id="reviewsToggle" style="cursor: pointer; user-select: none;">
        <span id="reviewsIcon">‚ñ∂</span> –û—Ç–∑—ã–≤—ã –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö
      </h3>
      <div id="reviewsContent" style="display: none;">
        <div class="form-group">
          <label>–§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É</label>
          <div class="form-row">
            <select id="revRest"></select>
            <button id="revLoad">üìù –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          </div>
        </div>
        <div id="reviews"></div>
      </div>
    </div>

    <!-- App Reviews Section -->
    <div class="admin-section">
      <h3 id="appReviewsToggle" style="cursor: pointer; user-select: none;">
        <span id="appReviewsIcon">‚ñ∂</span> –û—Ç–∑—ã–≤—ã –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
      </h3>
      <div id="appReviewsContent" style="display: none;">
        <div class="form-group">
          <button id="appRevLoad">üì± –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∑—ã–≤—ã –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
        </div>
        <div id="appReviews"></div>
      </div>
    </div>
  </div>
  <script>
    const api = location.origin + '/api';
    const tg = window.Telegram?.WebApp;
    const q = new URLSearchParams(location.search);
    const uid = tg?.initDataUnsafe?.user?.id || Number(q.get('uid')) || 0;
    console.log('DEBUG: uid =', uid);
    console.log('DEBUG: tg?.initDataUnsafe?.user?.id =', tg?.initDataUnsafe?.user?.id);
    console.log('DEBUG: q.get("uid") =', q.get('uid'));
    const headers = uid ? { 'X-Telegram-User-Id': String(uid), 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
    console.log('DEBUG: headers =', headers);

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    function showMessage(text, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      
      // –í—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      const container = document.querySelector('.container');
      container.insertBefore(messageDiv, container.firstChild);
      
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 5000);
    }

    async function load() {
      const res = await fetch(api + '/admin/restaurants', { headers });
      if (!res.ok) { alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'); return; }
      const rs = await res.json();
      const root = document.getElementById('list');
      root.innerHTML='';
      rs.forEach(r => {
        const el = document.createElement('div');
        el.className = 'restaurant';
        el.innerHTML = `
          <div class="restaurant-item">
            <div class="restaurant-info">
              <div class="title">#${r.id} ${r.name}</div>
              <div class="meta">
                <span class="status-${r.is_enabled ? 'on' : 'off'}">‚óè ${r.is_enabled ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span>
              </div>
              <div class="meta">
                <label>–ú–∏–Ω. –∑–∞–∫–∞–∑:</label>
                <input data-field="delivery_min_sum" value="${r.delivery_min_sum}" style="width:80px"/>
                <label>–î–æ—Å—Ç–∞–≤–∫–∞:</label>
                <input data-field="delivery_fee" value="${r.delivery_fee}" style="width:80px"/>
                <label>–í—Ä–µ–º—è (–º–∏–Ω):</label>
                <input data-field="delivery_time_minutes" value="${r.delivery_time_minutes}" style="width:80px"/>
              </div>
              <div class="meta">
                <label>–ê–¥—Ä–µ—Å:</label>
                <input data-field="address" value="${r.address}" style="width:70%"/>
              </div>
              <div class="meta">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <input data-field="phone" value="${r.phone}" style="width:50%"/>
              </div>
              <div class="meta">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <input data-field="description" value="${r.description||''}" style="width:80%"/>
              </div>
            </div>
            <div class="restaurant-actions">
              <button data-act="save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button data-act="toggle">${r.is_enabled ? 'üî¥ –í—ã–∫–ª—é—á–∏—Ç—å' : 'üü¢ –í–∫–ª—é—á–∏—Ç—å'}</button>
              <button data-act="del">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>`;
        el.querySelector('[data-act="save"]').onclick = async () => {
          const body = {};
          el.querySelectorAll('input[data-field]').forEach(inp => {
            const key = inp.getAttribute('data-field');
            let val = (inp.value || '').trim();
            if (['delivery_min_sum','delivery_fee','delivery_time_minutes'].includes(key)) {
              const n = parseInt(val, 10);
              if (!Number.isNaN(n)) val = n; else return;
            }
            body[key] = val;
          });
          const res = await fetch(api + '/admin/restaurants/' + r.id, { method:'PATCH', headers, body: JSON.stringify(body) });
          if (!res.ok) { alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); return; }
          const data = await res.json().catch(()=>({}));
          // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∫–∞–∑–∞–ª–æ—Å—å, —á—Ç–æ "—Å–ª–µ—Ç–∞–µ—Ç"
          if (data.restaurant) Object.assign(r, data.restaurant);
          load();
        };
        el.querySelector('[data-act="toggle"]').onclick = async () => {
          await fetch(api + '/admin/restaurants/' + r.id + '/status?enabled=' + (!r.is_enabled), { method:'PATCH', headers });
          load();
        };
        el.querySelector('[data-act="del"]').onclick = async () => {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω #' + r.id + '?')) return;
          await fetch(api + '/admin/restaurants/' + r.id, { method:'DELETE', headers });
          load();
        };
        root.appendChild(el);
      });
    }

    document.getElementById('addR').onclick = async () => {
      const name = document.getElementById('rname').value.trim();
      if (!name) return;
      await fetch(api + '/admin/restaurants', { method:'POST', headers, body: JSON.stringify({ name }) });
      document.getElementById('rname').value='';
      load();
    };
    
    document.getElementById('createRestWithAdmin').onclick = async () => {
      const name = document.getElementById('newRestName').value.trim();
      const username = document.getElementById('newRestUsername').value.trim();
      if (!name || !username) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∏ username –∞–¥–º–∏–Ω–∞', 'error');
        return;
      }
      
      const button = document.getElementById('createRestWithAdmin');
      const originalText = button.textContent;
      button.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';
      button.disabled = true;
      
      try {
        // –°–æ–∑–¥–∞–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω
        const restRes = await fetch(api + '/admin/restaurants', { 
          method:'POST', 
          headers, 
          body: JSON.stringify({ name }) 
        });
        if (!restRes.ok) {
          showMessage('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞', 'error');
          return;
        }
        const restaurant = await restRes.json();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–≤–µ–¥–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —á–∏—Å–ª–æ–º (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        let userData;
        if (/^\d+$/.test(username)) {
          // –≠—Ç–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          userData = { user_id: parseInt(username) };
        } else {
          // –≠—Ç–æ username, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å ID
          const userRes = await fetch(api + '/admin/users/resolve-username?username=' + encodeURIComponent(username), { 
            method:'GET', 
            headers 
          });
          if (!userRes.ok) {
            showMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª —Å –±–æ—Ç–æ–º', 'error');
            return;
          }
          userData = await userRes.json();
        }
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
        const bindRes = await fetch(api + '/admin/users/bind-admin?user_id=' + userData.user_id + '&restaurant_id=' + restaurant.id, { 
          method:'POST', 
          headers 
        });
        if (!bindRes.ok) {
          showMessage('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞', 'error');
          return;
        }
        
        showMessage(`‚úÖ –†–µ—Å—Ç–æ—Ä–∞–Ω "${name}" —Å–æ–∑–¥–∞–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} –Ω–∞–∑–Ω–∞—á–µ–Ω –µ–≥–æ –∞–¥–º–∏–Ω–æ–º`, 'success');
        document.getElementById('newRestName').value = '';
        document.getElementById('newRestUsername').value = '';
        load();
        loadUsers();
      } catch (error) {
        showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      } finally {
        button.textContent = originalText;
        button.disabled = false;
      }
    };
    document.getElementById('sendB').onclick = async () => {
      const text = document.getElementById('btext').value.trim();
      if (!text) return;
      await fetch(api + '/admin/broadcast', { method:'POST', headers, body: JSON.stringify({ text }) });
      document.getElementById('btext').value='';
      alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–Ω–∞–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
    };

    async function loadUsers() {
      const res = await fetch(api + '/admin/users?t=' + Date.now(), { headers });
      if (!res.ok) return;
      const us = await res.json();
      const root = document.getElementById('ulist');
      root.innerHTML = '';
      us.forEach(u => {
        const el = document.createElement('div');
        el.className = 'restaurant';
        el.innerHTML = `
          <div class="restaurant-item">
            <div class="restaurant-info">
              <div class="title">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${u.id}${u.username ? `<span class="username">@${u.username}</span>` : ''}</div>
              <div class="meta">
                <span class="status-${u.is_blocked ? 'off' : 'on'}">‚óè ${u.is_blocked ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–ê–∫—Ç–∏–≤–µ–Ω'}</span>
                ${u.restaurant_admin_of ? `üëë –ê–¥–º–∏–Ω —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ #${u.restaurant_admin_of}` : ''}
              </div>
              ${u.username ? `<div class="meta"><span class="username-info">@${u.username}</span></div>` : ''}
              ${u.name ? `<div class="meta">–ò–º—è: ${u.name}</div>` : ''}
              ${u.phone ? `<div class="meta">–¢–µ–ª–µ—Ñ–æ–Ω: ${u.phone}</div>` : ''}
            </div>
          </div>`;
        root.appendChild(el);
      });
    }

    async function resolveUserId(input) {
      const value = input.trim();
      if (/^\d+$/.test(value)) {
        return parseInt(value);
      } else if (value.startsWith('@')) {
        const res = await fetch(api + '/admin/users/resolve-username?username=' + encodeURIComponent(value), { headers });
        if (!res.ok) {
          throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
        const data = await res.json();
        return data.user_id;
      } else {
        throw new Error('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ @username');
      }
    }

    document.getElementById('blk').onclick = async () => {
      try {
        const input = (document.getElementById('uidInput').value||'').trim();
        if (!input) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username');
        const id = await resolveUserId(input);
        await fetch(api + '/admin/users/block?user_id=' + id + '&block=true', { method:'POST', headers });
        loadUsers();
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
      } catch (error) {
        alert(error.message);
      }
    };
    document.getElementById('unblk').onclick = async () => {
      try {
        const input = (document.getElementById('uidInput').value||'').trim();
        if (!input) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username');
        const id = await resolveUserId(input);
        await fetch(api + '/admin/users/block?user_id=' + id + '&block=false', { method:'POST', headers });
        loadUsers();
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
      } catch (error) {
        alert(error.message);
      }
    };
    document.getElementById('uload').onclick = loadUsers;
    document.getElementById('bindRA').onclick = async () => {
      try {
        const input = (document.getElementById('uidInput').value||'').trim();
        const rid = parseInt((document.getElementById('bindRestId').value||'').trim(),10);
        if (!input || !rid) return alert('–í–≤–µ–¥–∏—Ç–µ user_id/@username –∏ restaurant_id');
        const id = await resolveUserId(input);
        await fetch(api + '/admin/users/bind-admin?user_id=' + id + '&restaurant_id=' + rid, { method:'POST', headers });
        alert('–ù–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ #' + rid);
        loadUsers();
      } catch (error) {
        alert(error.message);
      }
    };

    load();
    loadUsers();

    async function loadStatsGlobal() {
      const res = await fetch(api + '/admin/stats?t=' + Date.now(), { headers });
      if (!res.ok) return;
      const s = await res.json();
      const el = document.getElementById('statsGlobal');
      el.innerHTML = `
        <div class="stats-card">
          <div class="title">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
          <div class="meta">–°–µ–≥–æ–¥–Ω—è: ${s.today.orders} –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å—É–º–º—É ${s.today.sum} ‚ÇΩ</div>
          <div class="meta">–û—Ç–º–µ–Ω–µ–Ω–æ: ${s.today.cancelled} | –ò–∑–º–µ–Ω–µ–Ω–æ: ${s.today.modified}</div>
          <div class="meta">–ú–µ—Å—è—Ü: ${s.month.orders} –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å—É–º–º—É ${s.month.sum} ‚ÇΩ</div>
          <div class="meta">–û—Ç–º–µ–Ω–µ–Ω–æ: ${s.month.cancelled} | –ò–∑–º–µ–Ω–µ–Ω–æ: ${s.month.modified}</div>
        </div>`;
    }

    async function populateRestaurantsSelect() {
      const res = await fetch(api + '/admin/restaurants?t=' + Date.now(), { headers });
      if (!res.ok) return;
      const rs = await res.json();
      const sel1 = document.getElementById('statsRest');
      const sel2 = document.getElementById('revRest');
      sel1.innerHTML = '';
      sel2.innerHTML = '<option value="">–í—Å–µ</option>';
      rs.forEach(r => {
        const o1 = document.createElement('option'); o1.value = r.id; o1.textContent = `#${r.id} ${r.name}`; sel1.appendChild(o1);
        const o2 = document.createElement('option'); o2.value = r.id; o2.textContent = `#${r.id} ${r.name}`; sel2.appendChild(o2);
      });
    }

    async function loadStatsByRestaurant() {
      const rid = Number(document.getElementById('statsRest').value);
      if (!rid) { document.getElementById('statsByRest').textContent = ''; return; }
      const res = await fetch(api + '/admin/stats/by-restaurant?restaurant_id=' + rid + '&t=' + Date.now(), { headers });
      if (!res.ok) return;
      const s = await res.json();
      document.getElementById('statsByRest').innerHTML = `
        <div class="stats-card">
          <div class="title">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ #${rid}</div>
          <div class="meta">–°–µ–≥–æ–¥–Ω—è: ${s.today.orders} –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å—É–º–º—É ${s.today.sum} ‚ÇΩ</div>
          <div class="meta">–û—Ç–º–µ–Ω–µ–Ω–æ: ${s.today.cancelled} | –ò–∑–º–µ–Ω–µ–Ω–æ: ${s.today.modified}</div>
          <div class="meta">–ú–µ—Å—è—Ü: ${s.month.orders} –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å—É–º–º—É ${s.month.sum} ‚ÇΩ</div>
          <div class="meta">–û—Ç–º–µ–Ω–µ–Ω–æ: ${s.month.cancelled} | –ò–∑–º–µ–Ω–µ–Ω–æ: ${s.month.modified}</div>
        </div>`;
    }

    async function loadReviews() {
      const rid = document.getElementById('revRest').value;
      const url = rid ? (api + '/admin/reviews?restaurant_id=' + rid + '&t=' + Date.now()) : (api + '/admin/reviews?t=' + Date.now());
      const res = await fetch(url, { headers });
      if (!res.ok) return;
      const data = await res.json();
      // fetch restaurants to map id -> name
      const rs = await (await fetch(api + '/admin/restaurants?t=' + Date.now(), { headers })).json();
      const idToName = new Map(rs.map(r => [r.id, r.name]));
      const root = document.getElementById('reviews');
      root.innerHTML = '';
      if (!data.length) { root.innerHTML = '<div class="meta">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>'; return; }
      data.forEach(r => {
        const el = document.createElement('div');
        el.className = 'review-item';
        const rname = idToName.get(r.restaurant_id) || ('–†–µ—Å—Ç–æ—Ä–∞–Ω ' + r.restaurant_id);
        el.innerHTML = `
          <div class="title">‚≠ê ${r.rating}/5 ¬∑ ${rname}</div>
          <div class="meta">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${r.user_id} ¬∑ üì¶ –ó–∞–∫–∞–∑ #${r.order_id}</div>
          <div class="meta">üí¨ ${(r.comment||'').replace(/</g,'&lt;')}</div>
          <button data-id="${r.id}" style="margin-top: 8px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>`;
        el.querySelector('button').onclick = async () => {
          await fetch(api + '/admin/reviews/' + r.id, { method:'DELETE', headers });
          loadReviews();
        };
        root.appendChild(el);
      });
    }

    // Admin Code Management
    async function loadAdminCode() {
      try {
        const res = await fetch(api + '/admin/admin-code', { headers });
        if (res.ok) {
          const data = await res.json();
          const currentCodeEl = document.getElementById('currentAdminCode');
          currentCodeEl.textContent = data.admin_code || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
        }
      } catch (error) {
        console.error('Error loading admin code:', error);
      }
    }

    document.getElementById('updateAdminCode').onclick = async () => {
      const newCode = document.getElementById('adminCodeInput').value.trim();
      if (!newCode) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ', 'error');
        return;
      }
      
      const button = document.getElementById('updateAdminCode');
      const originalText = button.textContent;
      button.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
      button.disabled = true;
      
      try {
        const res = await fetch(api + '/admin/admin-code', { 
          method: 'POST', 
          headers, 
          body: JSON.stringify({ admin_code: newCode }) 
        });
        
        if (res.ok) {
          showMessage('‚úÖ –ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
          document.getElementById('adminCodeInput').value = '';
          loadAdminCode();
        } else {
          const error = await res.json();
          showMessage('‚ùå –û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
      } catch (error) {
        showMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
      } finally {
        button.textContent = originalText;
        button.disabled = false;
      }
    };

    document.getElementById('statsLoad').onclick = loadStatsByRestaurant;
    document.getElementById('statsRefresh').onclick = loadStatsGlobal;
    document.getElementById('revLoad').onclick = loadReviews;

    // Collections Management
    async function loadCollections() {
      try {
        const res = await fetch(api + '/collections', { headers });
        if (!res.ok) return;
        const collections = await res.json();
        
        const root = document.getElementById('collectionsList');
        root.innerHTML = '';
        
        if (!collections.length) {
          root.innerHTML = '<div class="meta">–ù–µ—Ç –ø–æ–¥–±–æ—Ä–æ–∫</div>';
          return;
        }
        
        collections.forEach(collection => {
          const el = document.createElement('div');
          el.className = 'collection-item';
          el.innerHTML = `
            <div class="title">üìö ${collection.name}</div>
            <div class="meta">${collection.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
            <div class="meta">–≠–ª–µ–º–µ–Ω—Ç–æ–≤: ${collection.items_count} | –°—Ç–∞—Ç—É—Å: ${collection.is_enabled ? '‚úÖ –í–∫–ª—é—á–µ–Ω–∞' : '‚ùå –í—ã–∫–ª—é—á–µ–Ω–∞'}</div>
            <div class="form-row" style="margin-top: 8px;">
              <button data-id="${collection.id}" data-act="toggle">${collection.is_enabled ? '‚ùå –í—ã–∫–ª—é—á–∏—Ç—å' : '‚úÖ –í–∫–ª—é—á–∏—Ç—å'}</button>
              <button data-id="${collection.id}" data-act="edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button data-id="${collection.id}" data-act="items">üìã –≠–ª–µ–º–µ–Ω—Ç—ã</button>
              <button data-id="${collection.id}" data-act="del">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `;
          
          el.querySelector('[data-act="toggle"]').onclick = async () => {
            await fetch(api + '/collections/' + collection.id, { 
              method: 'PATCH', 
              headers, 
              body: JSON.stringify({ is_enabled: !collection.is_enabled }) 
            });
            loadCollections();
          };
          
          el.querySelector('[data-act="edit"]').onclick = () => {
            showEditCollectionModal(collection);
          };
          
          el.querySelector('[data-act="items"]').onclick = () => {
            showCollectionItemsModal(collection.id, collection.name);
          };
          
          el.querySelector('[data-act="del"]').onclick = async () => {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–±–æ—Ä–∫—É "${collection.name}"?`)) return;
            await fetch(api + '/collections/' + collection.id, { method: 'DELETE', headers });
            loadCollections();
          };
          
          root.appendChild(el);
        });
      } catch (error) {
        console.error('Error loading collections:', error);
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–±–æ—Ä–æ–∫', 'error');
      }
    }

         function showEditCollectionModal(collection) {
       const modal = document.createElement('div');
       modal.className = 'modal';
       modal.innerHTML = `
         <div class="modal-content">
           <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É</h3>
           <div class="form-group">
             <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
             <input id="editName" value="${collection.name}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏"/>
           </div>
           <div class="form-group">
             <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
             <input id="editDescription" value="${collection.description}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏"/>
           </div>
           <div class="form-group">
             <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
             <div class="file-upload">
               <input type="file" id="editImageFile" accept="image/*" />
               <div class="file-upload-label">
                 –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
               </div>
             </div>
             <input id="editImage" value="${collection.image}" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤—ã—à–µ"/>
             <div id="editImagePreview" style="margin-top: 8px;">
               ${collection.image ? `<img src="${collection.image}" class="image-preview" />` : ''}
             </div>
           </div>
           <div class="form-group">
             <label>–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
             <input id="editSortOrder" type="number" value="${collection.sort_order}" placeholder="0"/>
           </div>
           <div class="form-row">
             <button id="saveEdit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
             <button id="cancelEdit">‚ùå –û—Ç–º–µ–Ω–∞</button>
           </div>
         </div>
       `;
      
             document.body.appendChild(modal);
       
       // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏
       document.getElementById('editImageFile').addEventListener('change', async function() {
         const file = this.files[0];
         if (!file) return;
         
         if (!file.type.startsWith('image/')) {
           showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
           return;
         }
         
         const formData = new FormData();
         formData.append('image', file);
         
         try {
           const response = await fetch(api + '/collections/upload-image', {
             method: 'POST',
             headers: { 'X-Telegram-User-Id': uid },
             body: formData
           });
           
           if (response.ok) {
             const result = await response.json();
             document.getElementById('editImage').value = result.image_url;
             
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
             const preview = document.getElementById('editImagePreview');
             preview.innerHTML = `<img src="${result.image_url}" class="image-preview" />`;
             
             showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
           } else {
             showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
           }
         } catch (error) {
           console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
           showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
         }
       });
       
       document.getElementById('saveEdit').onclick = async () => {
        const name = document.getElementById('editName').value.trim();
        const description = document.getElementById('editDescription').value.trim();
        const image = document.getElementById('editImage').value.trim();
        const sort_order = parseInt(document.getElementById('editSortOrder').value) || 0;
        
        if (!name) {
          showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏', 'error');
          return;
        }
        
        try {
          await fetch(api + '/collections/' + collection.id, {
            method: 'PATCH',
            headers,
            body: JSON.stringify({ name, description, image, sort_order })
          });
          document.body.removeChild(modal);
          loadCollections();
          showMessage('–ü–æ–¥–±–æ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
        } catch (error) {
          showMessage('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏', 'error');
        }
      };
      
      document.getElementById('cancelEdit').onclick = () => {
        document.body.removeChild(modal);
      };
    }

    function showCollectionItemsModal(collectionId, collectionName) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <h3>–≠–ª–µ–º–µ–Ω—Ç—ã –ø–æ–¥–±–æ—Ä–∫–∏: ${collectionName}</h3>
          <div class="form-group">
            <label>–î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</label>
            <select id="itemType">
              <option value="restaurant">–†–µ—Å—Ç–æ—Ä–∞–Ω</option>
              <option value="dish">–ë–ª—é–¥–æ</option>
            </select>
            <select id="restaurantSelect" style="display: none;">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω</option>
            </select>
            <div id="dishSelectContainer" style="display: none;">
              <label>–í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–æ</label>
              <select id="dishSelect">
                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω</option>
              </select>
            </div>
            <input id="itemTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"/>
            <input id="itemSubtitle" placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫"/>
            <div class="form-group">
              <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
              <div class="file-upload">
                <input type="file" id="itemImageFile" accept="image/*" />
                <div class="file-upload-label">
                  –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                </div>
              </div>
              <input id="itemImage" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤—ã—à–µ"/>
              <div id="imagePreview" style="margin-top: 8px;"></div>
            </div>
            <div class="form-row">
              <button id="addItem">‚ûï –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</button>
              <button id="loadItems">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
          </div>
          <div id="itemsList"></div>
          <div class="form-row">
            <button id="closeItems">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
      document.getElementById('itemType').addEventListener('change', onItemTypeChange);
      
      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏
      async function loadRestaurants() {
        try {
          const res = await fetch(api + '/collections/restaurants', { headers });
          if (!res.ok) return;
          const restaurants = await res.json();
          
          const select = document.getElementById('restaurantSelect');
          select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω</option>';
          
          restaurants.forEach(restaurant => {
            const option = document.createElement('option');
            option.value = restaurant.id;
            option.textContent = restaurant.name;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Error loading restaurants:', error);
        }
      }
      
      async function loadDishes(restaurantId) {
        try {
          console.log('loadDishes called with restaurantId:', restaurantId);
          const url = restaurantId 
            ? api + '/collections/dishes?restaurant_id=' + restaurantId
            : api + '/collections/dishes';
          
          console.log('Fetching dishes from:', url);
          const res = await fetch(url, { headers });
          if (!res.ok) {
            console.error('Failed to load dishes, status:', res.status);
            return;
          }
          const dishes = await res.json();
          console.log('Loaded dishes:', dishes);
          
          const select = document.getElementById('dishSelect');
          console.log('dishSelect element:', select);
          select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–æ</option>';
          
          dishes.forEach(dish => {
            const option = document.createElement('option');
            option.value = dish.id;
            option.textContent = `${dish.name} (${dish.restaurant_name}) - ${dish.price} ‚ÇΩ`;
            select.appendChild(option);
          });
          console.log('Dishes loaded into select');
        } catch (error) {
          console.error('Error loading dishes:', error);
        }
      }
      
      function onItemTypeChange() {
        const itemType = document.getElementById('itemType').value;
        const restaurantSelect = document.getElementById('restaurantSelect');
        const dishSelectContainer = document.getElementById('dishSelectContainer');
        const dishSelect = document.getElementById('dishSelect');
        
        console.log('onItemTypeChange called with type:', itemType);
        console.log('restaurantSelect:', restaurantSelect);
        console.log('dishSelectContainer:', dishSelectContainer);
        console.log('dishSelect:', dishSelect);
        
        if (!dishSelect) {
          console.error('dishSelect element not found!');
          return;
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–ª–µ–∫—Ç—ã
        restaurantSelect.style.display = 'none';
        dishSelectContainer.style.display = 'none';
        
        if (itemType === 'restaurant') {
          restaurantSelect.style.display = 'block';
          loadRestaurants();
          // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
          restaurantSelect.onchange = null;
        } else if (itemType === 'dish') {
          restaurantSelect.style.display = 'block';
          dishSelectContainer.style.display = 'block';
          console.log('Setting dishSelectContainer display to block');
          loadRestaurants();
          // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –±–ª—é–¥
          dishSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω</option>';
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –¥–ª—è –±–ª—é–¥
          restaurantSelect.onchange = function() {
            console.log('Restaurant changed to:', this.value);
            const dishSelect = document.getElementById('dishSelect');
            if (this.value) {
              loadDishes(this.value);
            } else {
              dishSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω</option>';
            }
          };
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      document.getElementById('itemImageFile').addEventListener('change', async function() {
        const file = this.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
          showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
          return;
        }
        
        const formData = new FormData();
        formData.append('image', file);
        
        try {
          const response = await fetch(api + '/collections/upload-image', {
            method: 'POST',
            headers: { 'X-Telegram-User-Id': uid },
            body: formData
          });
          
          if (response.ok) {
            const result = await response.json();
            document.getElementById('itemImage').value = result.image_url;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = `<img src="${result.image_url}" class="image-preview" />`;
            
            showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
          } else {
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
          showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
        }
      });
      
      async function loadItems() {
        try {
          const res = await fetch(api + '/collections/' + collectionId + '/items', { headers });
          if (!res.ok) return;
          const items = await res.json();
          
          const root = document.getElementById('itemsList');
          root.innerHTML = '';
          
          if (!items.length) {
            root.innerHTML = '<div class="meta">–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤</div>';
            return;
          }
          
          items.forEach(item => {
            const el = document.createElement('div');
            el.className = 'item-element';
            el.innerHTML = `
              <div class="title">${item.title}</div>
              <div class="meta">${item.subtitle || '–ë–µ–∑ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞'} | –¢–∏–ø: ${item.item_type} | ID: ${item.item_id}</div>
              <div class="meta">–°—Ç–∞—Ç—É—Å: ${item.is_enabled ? '‚úÖ –í–∫–ª—é—á–µ–Ω' : '‚ùå –í—ã–∫–ª—é—á–µ–Ω'} | –ü–æ—Ä—è–¥–æ–∫: ${item.sort_order}</div>
              <div class="form-row" style="margin-top: 8px;">
                <button data-id="${item.id}" data-act="toggle">${item.is_enabled ? '‚ùå –í—ã–∫–ª—é—á–∏—Ç—å' : '‚úÖ –í–∫–ª—é—á–∏—Ç—å'}</button>
                <button data-id="${item.id}" data-act="edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button data-id="${item.id}" data-act="del">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `;
            
            el.querySelector('[data-act="toggle"]').onclick = async () => {
              await fetch(api + '/collections/' + collectionId + '/items/' + item.id, {
                method: 'PATCH',
                headers,
                body: JSON.stringify({ is_enabled: !item.is_enabled })
              });
              loadItems();
            };
            
            el.querySelector('[data-act="edit"]').onclick = () => {
              showEditItemModal(collectionId, item, loadItems);
            };
            
            el.querySelector('[data-act="del"]').onclick = async () => {
              if (!confirm(`–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç "${item.title}"?`)) return;
              await fetch(api + '/collections/' + collectionId + '/items/' + item.id, { method: 'DELETE', headers });
              loadItems();
            };
            
            root.appendChild(el);
          });
        } catch (error) {
          console.error('Error loading items:', error);
          showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤', 'error');
        }
      }
      
      document.getElementById('addItem').onclick = async () => {
        const item_type = document.getElementById('itemType').value;
        let item_id = 0;
        
        if (item_type === 'restaurant') {
          item_id = parseInt(document.getElementById('restaurantSelect').value);
        } else if (item_type === 'dish') {
          item_id = parseInt(document.getElementById('dishSelect').value);
        }
        
        const title = document.getElementById('itemTitle').value.trim();
        const subtitle = document.getElementById('itemSubtitle').value.trim();
        const image = document.getElementById('itemImage').value.trim();
        
        if (!item_id || !title) {
          showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –∏ –≤–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫', 'error');
          return;
        }
        
        try {
          await fetch(api + '/collections/' + collectionId + '/items', {
            method: 'POST',
            headers,
            body: JSON.stringify({ collection_id: collectionId, item_type, item_id, title, subtitle, image })
          });
          
          // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
          document.getElementById('restaurantSelect').value = '';
          document.getElementById('dishSelect').value = '';
          document.getElementById('itemTitle').value = '';
          document.getElementById('itemSubtitle').value = '';
          document.getElementById('itemImage').value = '';
          
          loadItems();
          showMessage('–≠–ª–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        } catch (error) {
          showMessage('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞', 'error');
        }
      };
      
      document.getElementById('loadItems').onclick = loadItems;
      document.getElementById('closeItems').onclick = () => {
        document.body.removeChild(modal);
      };
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
      onItemTypeChange();
      loadItems();
    }

         function showEditItemModal(collectionId, item, reloadCallback) {
       const modal = document.createElement('div');
       modal.className = 'modal';
       modal.innerHTML = `
         <div class="modal-content">
           <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç</h3>
           <div class="form-group">
             <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
             <input id="editItemTitle" value="${item.title}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"/>
           </div>
           <div class="form-group">
             <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
             <input id="editItemSubtitle" value="${item.subtitle}" placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫"/>
           </div>
           <div class="form-group">
             <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
             <div class="file-upload">
               <input type="file" id="editItemImageFile" accept="image/*" />
               <div class="file-upload-label">
                 –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
               </div>
             </div>
             <input id="editItemImage" value="${item.image}" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤—ã—à–µ"/>
             <div id="editItemImagePreview" style="margin-top: 8px;">
               ${item.image ? `<img src="${item.image}" class="image-preview" />` : ''}
             </div>
           </div>
           <div class="form-group">
             <label>–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
             <input id="editItemSortOrder" type="number" value="${item.sort_order}" placeholder="0"/>
           </div>
           <div class="form-row">
             <button id="saveItemEdit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
             <button id="cancelItemEdit">‚ùå –û—Ç–º–µ–Ω–∞</button>
           </div>
         </div>
       `;
      
             document.body.appendChild(modal);
       
       // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
       document.getElementById('editItemImageFile').addEventListener('change', async function() {
         const file = this.files[0];
         if (!file) return;
         
         if (!file.type.startsWith('image/')) {
           showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
           return;
         }
         
         const formData = new FormData();
         formData.append('image', file);
         
         try {
           const response = await fetch(api + '/collections/upload-image', {
             method: 'POST',
             headers: { 'X-Telegram-User-Id': uid },
             body: formData
           });
           
           if (response.ok) {
             const result = await response.json();
             document.getElementById('editItemImage').value = result.image_url;
             
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
             const preview = document.getElementById('editItemImagePreview');
             preview.innerHTML = `<img src="${result.image_url}" class="image-preview" />`;
             
             showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
           } else {
             showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
           }
         } catch (error) {
           console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
           showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
         }
       });
       
       document.getElementById('saveItemEdit').onclick = async () => {
        const title = document.getElementById('editItemTitle').value.trim();
        const subtitle = document.getElementById('editItemSubtitle').value.trim();
        const image = document.getElementById('editItemImage').value.trim();
        const sort_order = parseInt(document.getElementById('editItemSortOrder').value) || 0;
        
        if (!title) {
          showMessage('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫', 'error');
          return;
        }
        
        try {
          await fetch(api + '/collections/' + collectionId + '/items/' + item.id, {
            method: 'PATCH',
            headers,
            body: JSON.stringify({ title, subtitle, image, sort_order })
          });
          document.body.removeChild(modal);
          reloadCallback();
          showMessage('–≠–ª–µ–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        } catch (error) {
          showMessage('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞', 'error');
        }
      };
      
      document.getElementById('cancelItemEdit').onclick = () => {
        document.body.removeChild(modal);
      };
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
    async function loadAppReviews() {
      try {
        const res = await fetch(api + '/app-reviews', { headers });
        if (!res.ok) {
          document.getElementById('appReviews').innerHTML = '<div class="meta">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
          return;
        }
        const data = await res.json();
        const root = document.getElementById('appReviews');
        root.innerHTML = '';
        
        if (!data.reviews || !data.reviews.length) {
          root.innerHTML = '<div class="meta">–û—Ç–∑—ã–≤–æ–≤ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ—Ç</div>';
          return;
        }
        
        data.reviews.forEach(r => {
          const el = document.createElement('div');
          el.className = 'restaurant';
          const stars = '‚≠ê'.repeat(r.rating) + '‚òÜ'.repeat(5 - r.rating);
          const date = new Date(r.created_at).toLocaleDateString('ru-RU');
          el.innerHTML = `
            <div class="title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${r.user_id} - ${stars}</div>
            <div class="meta">–î–∞—Ç–∞: ${date}</div>
            ${r.comment ? `<div class="meta">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${r.comment}</div>` : ''}
          `;
          root.appendChild(el);
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:', error);
        document.getElementById('appReviews').innerHTML = '<div class="meta">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      }
    }

    // Event listeners for collections
    document.getElementById('createCollection').onclick = async () => {
      const name = document.getElementById('collectionName').value.trim();
      const description = document.getElementById('collectionDescription').value.trim();
      const image = document.getElementById('collectionImage').value.trim();
      
      if (!name) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏', 'error');
        return;
      }
      
      try {
        await fetch(api + '/collections', {
          method: 'POST',
          headers,
          body: JSON.stringify({ name, description, image })
        });
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
        document.getElementById('collectionName').value = '';
        document.getElementById('collectionDescription').value = '';
        document.getElementById('collectionImage').value = '';
        
        loadCollections();
        showMessage('–ü–æ–¥–±–æ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
      } catch (error) {
        showMessage('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏', 'error');
      }
    };
    
    document.getElementById('loadCollections').onclick = loadCollections;
    document.getElementById('appRevLoad').onclick = loadAppReviews;

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–µ–∫—Ü–∏–π
    function toggleSection(contentId, iconId) {
      const content = document.getElementById(contentId);
      const icon = document.getElementById(iconId);
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
      } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–µ–∫—Ü–∏–π
    document.getElementById('quickActionsToggle').onclick = () => {
      toggleSection('quickActionsContent', 'quickActionsIcon');
    };
    
    document.getElementById('usersToggle').onclick = () => {
      toggleSection('usersContent', 'usersIcon');
    };
    
    document.getElementById('systemToggle').onclick = () => {
      toggleSection('systemContent', 'systemIcon');
    };
    
    document.getElementById('collectionsToggle').onclick = () => {
      toggleSection('collectionsContent', 'collectionsIcon');
    };
    
    document.getElementById('restaurantsToggle').onclick = () => {
      toggleSection('restaurantsContent', 'restaurantsIcon');
    };
    
    document.getElementById('statsToggle').onclick = () => {
      toggleSection('statsContent', 'statsIcon');
    };
    
    document.getElementById('reviewsToggle').onclick = () => {
      toggleSection('reviewsContent', 'reviewsIcon');
    };
    
    document.getElementById('appReviewsToggle').onclick = () => {
      toggleSection('appReviewsContent', 'appReviewsIcon');
    };

    // –ø–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    load();
    loadUsers();
    loadStatsGlobal();
    populateRestaurantsSelect().then(() => { loadStatsByRestaurant(); });
    loadReviews();
    loadAdminCode();
    loadCollections();
  </script>
</body>
</html>

